# Makefile for AT91SAM7 hello world example. 
# Wolfgang Wieser 07/2007. 

OBJECTS = Cstartup.o Cstartup_SAM7.o main.o
LDSCRIPT = ../build/ld_flash.cmd
#LDSCRIPT = ../build/AT91SAM7S256-ROM.ld


# -mthumb-interwork
CFLAGS  = -I. -c -fno-common -O3 -g -std=gnu99 -Wall
AFLAGS  = -ahls -mapcs-32
LFLAGS  = -Map main.map -nostartfiles -T $(LDSCRIPT)

CC = arm-elf-gcc
LD = arm-elf-ld -v
AS = arm-elf-as
OBJCPY = arm-elf-objcopy
OBJDMP = arm-elf-objdump

CPFLAGS = --output-target=binary
ODFLAGS	= -x -S -t

OPENOCD = openocd

all: clean main.bin

clean:
	-rm -f $(OBJECTS) *.lst *.bin *.elf *.map main.dmp

flash: main.bin
	-sh flash.sh
	
#debug: main.elf
#	$(OPENOCD) -f openocd.cfg

#dist:
#	tar -c *.h *.c *.s Makefile *.cmd *.cfg openocd_doflash | gzip > minimal_hello_world.tar.gz

main.bin: main.elf 
	$(OBJCPY) $(CPFLAGS) main.elf main.bin
	$(OBJDMP) $(ODFLAGS) main.elf > main.dmp
	ls -l main.elf main.bin

main.elf: $(OBJECTS) $(LDSCRIPT)
	@ echo "...linking"
	$(LD) $(LFLAGS) -o main.elf $(OBJECTS)

Cstartup.o: Cstartup.S
	$(AS) $(AFLAGS) Cstartup.S -o Cstartup.o > Cstartup.lst

Cstartup_SAM7.o: Cstartup_SAM7.c
	$(CC) $(CFLAG) Cstartup_SAM7.c

main.o: main.c 
	$(CC) $(CFLAGS) main.c
